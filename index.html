<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ガチャ検索（商品名 → 棚番/向き/階層）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
  input[type="search"], input[type="url"]{flex:1;min-width:220px;padding:10px 12px;border:1px solid #ccc;border-radius:8px;font-size:16px}
  .pill{padding:8px 12px;border:1px solid #ddd;border-radius:999px;background:#fff;font-size:14px;cursor:pointer;transition:.2s}
  .pill:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .hint{color:#666;font-size:13px;margin-top:8px}
  .count{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:15px}
  th{position:sticky;top:0;background:#fff;z-index:1}
  mark{background:#ffec99}
  .status{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:13px}
  .status .dot{width:10px;height:10px;border-radius:50%}
  .status.load .dot{background:#1f6feb;animation:pulse 1s infinite}
  .status.ok   .dot{background:#2da44e}
  .status.err  .dot{background:#d1242f}
  .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;opacity:0;transform:translateY(8px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  @keyframes pulse{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
  .kiosk .staff-only{display:none!important}
  .gear{position:fixed;right:14px;top:14px;opacity:.25;cursor:pointer;font-size:18px;user-select:none}
  .kiosk .gear{opacity:.15}
  .gear:hover{opacity:.7}
  .kiosk .staff-only{display:none!important}
  .gear{position:fixed;right:14px;top:14px;opacity:.25;cursor:pointer;font-size:18px;user-select:none;z-index:50}
  .kiosk .gear{opacity:.15}
  .gear:hover{opacity:.7}
  .map-section{margin-top:28px}
  .map-section h2{margin:0 0 12px;font-size:18px}
  .map-hint{font-size:12px;color:#666;margin-top:8px}
  .store-map{border:1px solid #ddd;border-radius:12px;padding:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:12px;background:#fafafa}
  .map-shelf{position:relative;padding:18px 8px;border-radius:10px;background:#fff;border:1px solid #ccc;text-align:center;font-size:14px;line-height:1.4;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.05)}
  .map-shelf::after{content:attr(data-label);display:block;font-size:11px;color:#666;margin-top:4px}
  .map-shelf.active{border-color:#1f6feb;background:#e8f1ff;box-shadow:0 0 0 3px rgba(31,111,235,.15)}
  .map-shelf .map-count{position:absolute;top:6px;right:6px;font-size:11px;background:#1f6feb;color:#fff;padding:2px 6px;border-radius:999px;min-width:20px;text-align:center}
/* PINモーダル */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:100}
.modal.show{display:flex}
.modal .box{background:#fff;border-radius:12px;padding:18px 16px;min-width:280px;max-width:90vw;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.modal h3{margin:0 0 8px;font-size:16px}
.modal .row{display:flex;gap:8px;margin-top:10px}
.modal input{flex:1;padding:10px 12px;border:1px solid #ccc;border-radius:8px;font-size:16px}
.modal button{padding:10px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
.modal .error{color:#c00;font-size:12px;margin-top:6px;min-height:16px}
</style>
<body>
<h1>ガチャ検索（商品名 → 棚番 / 向き / 階層）</h1>
<div id="gear" class="gear" title="スタッフ画面へ（Alt+K）">⚙</div>
<!-- PIN モーダル -->
<div id="pinModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
  <div class="box">
    <h3 id="pinTitle">スタッフ用PINを入力</h3>
    <div class="row">
      <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN" />
      <button id="pinOk">OK</button>
      <button id="pinCancel">キャンセル</button>
    </div>
    <div id="pinErr" class="error"></div>
  </div>
</div>

<!-- 1) 公開CSVのURL（?csv=... 付きリンクで自動設定も可） -->
<div class="row staff-only">
  <input id="csvUrl" type="url" placeholder="Googleスプレッドシートの “ウェブに公開” CSV URL" />
  <button id="load" class="pill">読み込み</button>
  <button id="share" class="pill" title="このCSVで開く専用リンクを作成">この設定で共有リンク</button>
</div>
<div id="status" class="status staff-only" aria-live="polite"><span class="dot" style="background:#ccc"></span><span>未読み込み</span></div>
<div class="hint staff-only">※ Googleスプレッドシート → <b>ファイル ＞ 共有 ＞ ウェブに公開</b> → 形式「CSV」→ URLをここに貼付。1行目は見出し（例：<b>商品名, 棚番, 向き, 階層</b>）。Enterキーでも読み込みできます。</div>

<!-- 2) 商品名で検索 → 棚番/向き/階層を表示 -->
<div class="row" style="margin-top:12px">
  <input id="q" type="search" placeholder="商品名で検索（例：ディズニーめじるしキーホルダー）" />
  <span id="count" class="count">0件</span>
  <button id="clear" class="pill">リセット</button>
</div>

<table id="tbl" hidden>
  <thead><tr><th>商品名</th><th>棚番</th><th>向き</th><th>階層</th></tr></thead>
  <tbody id="tbody"></tbody>
</table>

<section class="map-section" aria-label="店内マップ">
  <h2>店内マップ</h2>
  <div id="storeMap" class="store-map">
    <div class="map-shelf" data-shelf="A1" data-label="入口横">A1<span class="map-count" hidden>0</span></div>
    <div class="map-shelf" data-shelf="A2" data-label="中央">A2<span class="map-count" hidden>0</span></div>
    <div class="map-shelf" data-shelf="A3" data-label="奥側">A3<span class="map-count" hidden>0</span></div>
    <div class="map-shelf" data-shelf="B1" data-label="入口横">B1<span class="map-count" hidden>0</span></div>
    <div class="map-shelf" data-shelf="B2" data-label="中央">B2<span class="map-count" hidden>0</span></div>
    <div class="map-shelf" data-shelf="B3" data-label="奥側">B3<span class="map-count" hidden>0</span></div>
  </div>
  <p class="map-hint">検索結果に該当する棚をハイライトし、件数バッジを表示します。棚の配置はHTMLの <code>data-shelf</code> を編集して調整できます。</p>
</section>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
// ===== 正規化ユーティリティ =====
const toHiragana = s => s.replace(/[ァ-ヶ]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
const toZenkakuLess = s => s.normalize("NFKC");
const norm = s => toHiragana(toZenkakuLess((s||"").toLowerCase()));
const esc = s => String(s).replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
function highlight(text, query){
  if(!query) return esc(text);
  const raw = String(text);
  const nText = norm(raw), nQ = norm(query);
  const i = nText.indexOf(nQ);
  if(i < 0) return esc(raw);
  return esc(raw.slice(0,i)) + '<mark>' + esc(raw.slice(i, i+query.length)) + '</mark>' + esc(raw.slice(i+query.length));
}

// ===== 要素 =====
const el = id => document.getElementById(id);
const csvUrl = el('csvUrl');
const btnLoad = el('load');
const btnShare = el('share');
const q = el('q');
const clearBtn = el('clear');
const tbl = el('tbl');
const tbody = el('tbody');
const count = el('count');
const statusBar = el('status');
const toast = el('toast');
const storeMap = el('storeMap');
const mapShelves = storeMap ? Array.from(storeMap.querySelectorAll('[data-shelf]')) : [];

// ===== データ状態 =====
let headers = [];
let rows = [];
let productCol = '';
let tanaCol = '';
let mukiCol = '';
let kaisoCol = '';
let loading = false;

// 設定：スタッフPIN（デフォルト・URLで上書き可）
let ADMIN_PIN = '1234'; // ★必要に応じて変更

// URLパラメータ処理（?csv=...）
const params = new URLSearchParams(location.search);
if(params.get('pin')){ ADMIN_PIN = params.get('pin'); } // URLでPIN上書き（例：?kiosk=1&pin=9999）
const isKiosk = params.get('kiosk') === '1' || params.get('mode') === 'customer';
if(isKiosk){ document.body.classList.add('kiosk'); }
if(params.get('csv')){ csvUrl.value = params.get('csv'); fetchCSV(); }

btnLoad.onclick = fetchCSV;
btnShare.onclick = () => {
  if(!csvUrl.value) return showToast('CSVの公開URLを入力してください');
  const url = new URL(location.href);
  url.searchParams.set('csv', csvUrl.value);
  url.searchParams.set('kiosk', '1');
  url.searchParams.set('mode', 'customer');
  navigator.clipboard.writeText(url.toString()).then(()=>showToast('共有リンクをコピーしました。QR化して使えます。'));
};

// Enterキーで読み込み（URL欄）
csvUrl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); fetchCSV(); }});

q.addEventListener('input', render);
q.setAttribute('autofocus','autofocus');

// PINモーダル制御
const pinModal = document.getElementById('pinModal');
const pinInput = document.getElementById('pinInput');
const pinOk = document.getElementById('pinOk');
const pinCancel = document.getElementById('pinCancel');
const pinErr = document.getElementById('pinErr');
function openPin(){ pinErr.textContent=''; pinInput.value=''; pinModal.classList.add('show'); setTimeout(()=>pinInput.focus(), 50); }
function closePin(){ pinModal.classList.remove('show'); }
function requirePinThen(next){
  openPin();
  const onOK = () => {
    if(pinInput.value===ADMIN_PIN){
      closePin();
      next && next();
    } else {
      pinErr.textContent = 'PINが違います';
      pinInput.select();
    }
  };
  pinOk.onclick = onOK;
  pinCancel.onclick = ()=>{ closePin(); };
  pinInput.onkeydown = (e)=>{ if(e.key==='Enter') onOK(); if(e.key==='Escape') closePin(); };
}

// ギアクリック/Alt+K でスタッフ画面へ（kiosk→staff はPIN必須）
const gear = document.getElementById('gear');
gear.addEventListener('click', (e)=>{
  if(document.body.classList.contains('kiosk')){
    // kiosk時はPIN要求
    requirePinThen(()=>{ document.body.classList.remove('kiosk'); showToast('スタッフ画面に切替'); });
  } else {
    document.body.classList.add('kiosk'); showToast('利用者画面に切替');
  }
});
clearBtn.onclick = ()=>{ q.value=''; render(); q.focus(); };

function normalizeShelf(v){
  return norm(String(v||'')).replace(/\s+/g,'');
}

function updateMapHighlight(matches){
  if(!mapShelves.length) return;
  const counts = new Map();
  const idxTana = headers.indexOf(tanaCol);
  matches.forEach(row=>{
    const shelf = normalizeShelf(idxTana >= 0 ? row[idxTana] : '');
    if(!shelf) return;
    counts.set(shelf, (counts.get(shelf)||0)+1);
  });
  lastCounts = counts;
  mapShelves.forEach(node=>{
    const shelf = normalizeShelf(node.dataset.shelf||'');
    const count = counts.get(shelf)||0;
    node.classList.toggle('active', count>0);
    const badge = node.querySelector('.map-count');
    if(badge){
      badge.textContent = count;
      badge.hidden = count===0;
    }
  });
}

let hoverShelf = '';
let lastCounts = new Map();
tbody.addEventListener('mouseover', (e)=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  const shelfCell = tr.children[1];
  if(!shelfCell) return;
  hoverShelf = normalizeShelf(shelfCell.textContent);
  updateMapHighlightForHover();
});
tbody.addEventListener('focusin', (e)=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  const shelfCell = tr.children[1];
  if(!shelfCell) return;
  hoverShelf = normalizeShelf(shelfCell.textContent);
  updateMapHighlightForHover();
});
tbody.addEventListener('mouseleave', ()=>{ hoverShelf=''; updateMapHighlightForHover(); });
tbody.addEventListener('focusout', (e)=>{
  if(!tbody.contains(document.activeElement)){ hoverShelf=''; updateMapHighlightForHover(); }
});

function updateMapHighlightForHover(){
  if(!mapShelves.length) return;
  if(!hoverShelf){
    updateMapHighlight(lastMatches);
    return;
  }
  mapShelves.forEach(node=>{
    const shelf = normalizeShelf(node.dataset.shelf||'');
    const isActive = shelf === hoverShelf;
    node.classList.toggle('active', isActive);
    const badge = node.querySelector('.map-count');
    if(badge){
      if(isActive){
        const count = lastCounts.get(shelf) || 0;
        badge.textContent = count || 1;
        badge.hidden = false;
      }else{
        badge.hidden = true;
      }
    }
  });
}

let lastMatches = [];

function setStatus(type, text){
  statusBar.className = 'status ' + (type||'');
  const dot = statusBar.querySelector('.dot');
  if(type==='load'){ dot.style.background='#1f6feb'; }
  else if(type==='ok'){ dot.style.background='#2da44e'; }
  else if(type==='err'){ dot.style.background='#d1242f'; }
  else { dot.style.background='#ccc'; }
  statusBar.querySelector('span:nth-child(2)').textContent = text || '';
}

function setLoadingState(is){
  loading = is;
  btnLoad.disabled = is;
  btnShare.disabled = is;
  csvUrl.disabled = is;
  btnLoad.textContent = is ? '読み込み中…' : '読み込み';
}

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove('show'), 2200);
}

async function fetchCSV(){
  if(loading) return;
  const url = (csvUrl.value||'').trim();
  if(!/^https?:\/\//.test(url)) { showToast('CSVの公開URLを入力してください'); return; }
  try{
    setLoadingState(true);
    setStatus('load','CSVを取得しています…');
    const u = new URL(url); u.searchParams.set('_t', Date.now());
    const res = await fetch(u.toString(), {mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const mat = parseCSV(text);
    if(!mat.length) throw new Error('CSVが空です');
    headers = mat[0].map(h=>h.trim());
    rows = mat.slice(1).filter(r=>r.length && r.some(x=>String(x).trim()!==''));

    const findCol = (likes) => headers.find(h => likes.some(l => norm(h).includes(norm(l)))) || '';
    productCol = findCol(['商品名','品名','名前','product','title','name']);
    tanaCol    = findCol(['棚番','棚','列','shelf','tana']);
    mukiCol    = findCol(['向き','方向','向','orientation','muki']);
    kaisoCol   = findCol(['階層','段','階','level','tier','kaiso']);

    if(!productCol) throw new Error('「商品名」に相当する列が見つかりません（見出し例：商品名）。');

    tbl.hidden = false;
    render();
    const now = new Date();
    setStatus('ok', `読み込み完了（${now.toLocaleString()}）`);
    showToast('✓ 読み込み完了');
  }catch(err){
    console.error(err);
    setStatus('err', '読み込み失敗：' + err.message);
    showToast('読み込みに失敗しました');
  }finally{
    setLoadingState(false);
  }
}

function parseCSV(str){
  const out=[]; let i=0, cur='', row=[], inQ=false;
  const pushCell=()=>{ row.push(cur); cur=''; };
  const pushRow=()=>{ out.push(row); row=[]; };
  while(i<str.length){
    const c=str[i];
    if(inQ){
      if(c==='"'){
        if(str[i+1]==='"'){ cur+='"'; i++; } else { inQ=false; }
      } else cur+=c;
    } else {
      if(c==='"') inQ=true;
      else if(c===',') pushCell();
      else if(c==='\r'){}                 // 改行はエスケープで判定
      else if(c==='\n'){ pushCell(); pushRow(); } // 同上
      else cur+=c;
    }
    i++;
  }
  if(cur!==''||row.length){ pushCell(); pushRow(); }
  while(out.length && out[out.length-1].length===1 && out[out.length-1][0]==='') out.pop();
  return out;
}

function render(){
  if(!rows.length) return;
  const query = q.value.trim();
  const idxProduct = headers.indexOf(productCol);
  const matches = rows.filter(r => {
    if(!query) return true; // 未入力時は全件表示
    const v = r[idxProduct] ?? '';
    return norm(String(v)).includes(norm(query));
  });

  count.textContent = matches.length + '件';
  lastMatches = matches;

  const iTana = headers.indexOf(tanaCol);
  const iMuki = headers.indexOf(mukiCol);
  const iKaiso = headers.indexOf(kaisoCol);

  tbody.innerHTML = matches.map(r => {
    const vName  = r[idxProduct] ?? '';
    const vTana  = (iTana>=0? r[iTana] : '');
    const vMuki  = (iMuki>=0? r[iMuki] : '');
    const vKaiso = (iKaiso>=0? r[iKaiso]: '');
    return `<tr>
      <td>${highlight(vName, query)}</td>
      <td>${esc(vTana)}</td>
      <td>${esc(vMuki)}</td>
      <td>${esc(vKaiso)}</td>
    </tr>`;
  }).join('');

  updateMapHighlight(matches);
}
// ---- 画面モード切替：Alt+K でスタッフUIの表示/非表示 ----
document.addEventListener('keydown', (e)=>{
  if(e.altKey && (e.key==='k' || e.key==='K')){
    e.preventDefault();
    const toKiosk = !document.body.classList.contains('kiosk');
    if(toKiosk){
      document.body.classList.add('kiosk');
      showToast('利用者画面に切替');
    }else{
      requirePinThen(()=>{
        document.body.classList.remove('kiosk');
        showToast('スタッフ画面に切替');
      });
    }
  }
});
</script>
</body>
</html>
